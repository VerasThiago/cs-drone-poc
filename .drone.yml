pipeline:

  install-dependencies:
    image: node:12
    commands:
      - yarn

  build:
    image: node:12
    commands:
      - yarn build

  test:
    image: node:12
    commands:
      - yarn test

  publish:
    image: archlinux
    when:
      event: tag
    tag:
      - ${DRONE_TAG##v}
    # privileged: true
    commands:
      # install from package managers
      # - pacman -Sy --noconfirm docker python-pip libffi git
      # - pip install awscli
      # # docker daemon
      # - dockerd &
      # - sleep 15
      # - (curl -sSL "https://github.com/buildpacks/pack/releases/download/v0.19.0/pack-v0.19.0-linux.tgz" | tar -C /usr/local/bin/ --no-same-owner -xzv pack)
      # -  pack build 558830342743.dkr.ecr.us-east-1.amazonaws.com/cs-drone-poc:$${DRONE_TAG} --builder gcr.io/buildpacks/builder:v1
      # # push to ecr
      # - aws ecr get-login --no-include-email --region us-east-1 | bash
      # - docker push 558830342743.dkr.ecr.us-east-1.amazonaws.com/cs-drone-poc:$${DRONE_TAG}
      - echo $${DRONE_TAG}
      - echo $(DRONE_TAG)
      - echo $DRONE_TAG

  mark-as-latest-if-stable:
    image: plugins/webhook
    when:
      event: tag
    urls: http://releases.ingress.vtex.io/latest-if-stable/cs-drone-poc/${DRONE_TAG##v}
    method: PATCH

  register:
    image: plugins/webhook
    when:
      event: tag
    urls: http://router.aws-us-east-1.vtex.io/_services
    valid_response_codes: [200, 204]
    environment:
      HTTP_PROXY: io-integrations.internal.aws-us-east-1.vtex.io
    template: >
      {
        "name": "cs-drone-poc",
        "version": "${DRONE_TAG##v}",
        "image": "558830342743.dkr.ecr.us-east-1.amazonaws.com/cs-drone-poc:${DRONE_TAG##v}",
        "region": "aws-us-east-1",
        "labels": {
          "monitored": "true"
        }
      }
  notify:
    image: plugins/webhook
    when:
      event: tag
      status: [success, failure]
    urls: https://vtex.myvtex.com/_v/drone-notifications/notify
    valid_response_codes: [200, 204]
    username: drone
    password: YzNWd1pYSnpaV055WlhSd1lYTnpkMjl5WkdsbVptOTFibVJqWVd4c09UUXdNekV3TWpBPQ==